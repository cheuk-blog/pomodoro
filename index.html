<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>極簡番茄鐘</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #f8f9fa;
      font-family: system-ui, -apple-system, sans-serif;
      color: #333;
    }
    h1 {
      font-size: 1.2rem;
      margin: 0 0 1.5rem;
      opacity: 0.6;
      letter-spacing: 0.3em;
    }
    #time {
      font-size: 8rem;
      font-weight: 300;
      letter-spacing: -0.05em;
      margin: 0;
      user-select: none;
    }
    #status {
      font-size: 1.4rem;
      margin: 1rem 0 1.5rem;
      color: #555;
    }
    .controls {
      margin-top: 2rem;
      display: flex;
      gap: 1.5rem;
    }
    button {
      background: transparent;
      border: 2px solid #333;
      color: #333;
      padding: 0.7rem 1.6rem;
      font-size: 1.05rem;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover {
      background: #333;
      color: white;
    }
    button.active {
      background: #333;
      color: white;
    }
    .mode-buttons {
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    .mode-btn {
      background: transparent;
      border: none;
      font-size: 1.05rem;
      color: #777;
      cursor: pointer;
      padding: 0.5rem 1.1rem;
      border-radius: 999px;
      transition: all 0.2s;
    }
    .mode-btn.active {
      color: #333;
      background: rgba(0,0,0,0.08);
    }
    #custom-panel {
      display: none;
      margin: 1.5rem 0;
      text-align: center;
      background: rgba(0,0,0,0.03);
      padding: 1.5rem 2.5rem;
      border-radius: 12px;
    }
    .custom-row {
      margin: 1rem 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
    }
    .custom-row label {
      font-size: 1.1rem;
      min-width: 140px;
      text-align: right;
    }
    input[type="number"] {
      width: 90px;
      font-size: 1.2rem;
      padding: 0.5rem;
      text-align: center;
      border: 2px solid #ccc;
      border-radius: 8px;
    }
    #save-custom {
      margin-top: 1.5rem;
      padding: 0.7rem 2.5rem;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>

  <h1>極簡番茄鐘</h1>

  <div class="mode-buttons">
    <button class="mode-btn active" data-min="55" data-type="focus">專注</button>
    <button class="mode-btn" data-min="15" data-type="short">短休</button>
    <button class="mode-btn" data-min="30" data-type="long">長休</button>
    <button class="mode-btn" id="custom-btn">調整設定</button>
  </div>

  <div id="custom-panel">
    <div class="custom-row">
      <label>專注時間：</label>
      <input type="number" id="focus-min" min="1" max="180" value="55" /> 分鐘
    </div>
    <div class="custom-row">
      <label>短休息：</label>
      <input type="number" id="short-min" min="1" max="60" value="15" /> 分鐘
    </div>
    <div class="custom-row">
      <label>長休息：</label>
      <input type="number" id="long-min" min="1" max="120" value="30" /> 分鐘
    </div>
    <div class="custom-row">
      <label>每幾個番茄長休：</label>
      <input type="number" id="cycle-count" min="1" max="10" value="4" /> 個
    </div>
    <button id="save-custom">儲存並套用</button>
  </div>

  <div id="time">55:00</div>
  <div id="status">已完成 0/4 番茄</div>

  <div class="controls">
    <button id="start">開始</button>
    <button id="reset">重置</button>
  </div>

  <script>
    let timer;
    let timeLeft;
    let isRunning = false;
    let currentMode;
    let currentType = 'focus';
    let pomodoroCount = 0;

    // 自訂參數（預設值）
    let focusMin   = 55;
    let shortMin   = 15;
    let longMin    = 30;
    let cycleCount = 4;

    const timeDisplay   = document.getElementById('time');
    const statusDisplay = document.getElementById('status');
    const startBtn      = document.getElementById('start');
    const resetBtn      = document.getElementById('reset');
    const modeBtns      = document.querySelectorAll('.mode-btn:not(#custom-btn)');
    const customBtn     = document.getElementById('custom-btn');
    const customPanel   = document.getElementById('custom-panel');
    const focusInput    = document.getElementById('focus-min');
    const shortInput    = document.getElementById('short-min');
    const longInput     = document.getElementById('long-min');
    const cycleInput    = document.getElementById('cycle-count');
    const saveCustomBtn = document.getElementById('save-custom');

    // 從 localStorage 載入並立即套用
    function loadAndApplySettings() {
      const saved = localStorage.getItem('pomodoroSettings');
      if (saved) {
        try {
          const settings = JSON.parse(saved);
          focusMin   = Number(settings.focus)   || 55;
          shortMin   = Number(settings.short)   || 15;
          longMin    = Number(settings.long)    || 30;
          cycleCount = Number(settings.cycle)   || 4;

          focusInput.value  = focusMin;
          shortInput.value  = shortMin;
          longInput.value   = longMin;
          cycleInput.value  = cycleCount;

          // 立即套用到計時器
          currentMode = focusMin.toString();
          timeLeft = focusMin * 60;

          // 更新狀態顯示
          statusDisplay.textContent = `已完成 0/${cycleCount} 番茄`;
        } catch (e) {
          console.error('localStorage 格式錯誤，使用預設值', e);
          initDefault();
        }
      } else {
        initDefault();
      }
      updateDisplay();
    }

    function initDefault() {
      currentMode = focusMin.toString();
      timeLeft = focusMin * 60;
    }

    function saveSettings() {
      const settings = {
        focus: focusMin,
        short: shortMin,
        long:  longMin,
        cycle: cycleCount
      };
      localStorage.setItem('pomodoroSettings', JSON.stringify(settings));
    }

    function updateDisplay() {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      timeDisplay.textContent = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
      document.title = timeDisplay.textContent + ' | 番茄鐘';
      statusDisplay.textContent = `已完成 ${pomodoroCount}/${cycleCount} 番茄`;
    }

    function startTimer() {
      if (isRunning) {
        clearInterval(timer);
        startBtn.textContent = '繼續';
        isRunning = false;
      } else {
        timer = setInterval(() => {
          if (timeLeft > 0) {
            timeLeft--;
            updateDisplay();
          }
          if (timeLeft <= 0) {
            clearInterval(timer);
            isRunning = false;
            startBtn.textContent = '開始';

            if (currentType === 'focus') {
              pomodoroCount++;
              if (pomodoroCount >= cycleCount) {
                alert(`已完成 ${cycleCount} 個番茄！進入長休息～`);
                switchToLongRest();
                pomodoroCount = 0;
              } else {
                alert('番茄完成！短休息開始～');
                switchToShortRest();
              }
            } else {
              alert('休息結束！繼續專注吧～');
              switchToFocus();
            }
          }
        }, 1000);
        startBtn.textContent = '暫停';
        isRunning = true;
      }
    }

    function switchToFocus() {
      currentMode = focusMin.toString();
      currentType = 'focus';
      timeLeft = focusMin * 60;
      highlightMode('focus');
      updateDisplay();
    }

    function switchToShortRest() {
      currentMode = shortMin.toString();
      currentType = 'short';
      timeLeft = shortMin * 60;
      highlightMode('short');
      updateDisplay();
    }

    function switchToLongRest() {
      currentMode = longMin.toString();
      currentType = 'long';
      timeLeft = longMin * 60;
      highlightMode('long');
      updateDisplay();
    }

    function highlightMode(type) {
      modeBtns.forEach(btn => btn.classList.remove('active'));
      customBtn.classList.remove('active');
      customPanel.style.display = 'none';

      if (type === 'focus') modeBtns[0].classList.add('active');
      else if (type === 'short') modeBtns[1].classList.add('active');
      else if (type === 'long')  modeBtns[2].classList.add('active');
    }

    function resetTimer() {
      clearInterval(timer);
      switchToFocus();
      pomodoroCount = 0;
      isRunning = false;
      startBtn.textContent = '開始';
      updateDisplay();
    }

    function showCustomPanel() {
      modeBtns.forEach(btn => btn.classList.remove('active'));
      customBtn.classList.add('active');
      customPanel.style.display = 'block';
      focusInput.value  = focusMin;
      shortInput.value  = shortMin;
      longInput.value   = longMin;
      cycleInput.value  = cycleCount;
    }

    function saveCustomSettings() {
      const f = parseInt(focusInput.value);
      const s = parseInt(shortInput.value);
      const l = parseInt(longInput.value);
      const c = parseInt(cycleInput.value);

      if (isNaN(f) || f < 1 || f > 180 ||
          isNaN(s) || s < 1 || s > 60  ||
          isNaN(l) || l < 1 || l > 120 ||
          isNaN(c) || c < 1 || c > 10) {
        alert('專注：1-180 分\n短休：1-60 分\n長休：1-120 分\n番茄數：1-10 個');
        return;
      }

      focusMin   = f;
      shortMin   = s;
      longMin    = l;
      cycleCount = c;

      saveSettings();

      alert(`設定已成功儲存！\n專注：${focusMin} 分\n短休：${shortMin} 分\n長休：${longMin} 分\n每 ${cycleCount} 個番茄長休`);

      customPanel.style.display = 'none';
      resetTimer();
    }

    // 事件綁定
    startBtn.addEventListener('click', startTimer);
    resetBtn.addEventListener('click', resetTimer);

    modeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        currentMode = btn.dataset.min;
        currentType = btn.dataset.type;
        timeLeft = parseInt(currentMode) * 60;
        highlightMode(currentType);
        resetTimer();
      });
    });

    customBtn.addEventListener('click', showCustomPanel);
    saveCustomBtn.addEventListener('click', saveCustomSettings);

    // 頁面載入時執行
    loadAndApplySettings();  // 這行確保一開始就用儲存的值
  </script>

</body>
</html>
